@page "/items/new"
@using SharedModels
@inject Services.ItemApiClient ItemApi
@inject NavigationManager Nav

<style>
    .new-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem
    }

        .new-header h1 {
            margin: 0;
            font-size: 1.75rem
        }

        .new-header .subtitle {
            color: #6b7280;
            margin: .25rem 0 0
        }

    .new-form {
        max-width: 28rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: .25rem;
        display: block
    }
</style>
<PageTitle>New Item · Inventory</PageTitle>

<div class="new-header">
    <div>
        <h1>New Item</h1>
        <p class="subtitle">Add a product to the catalogue</p>
    </div>
    <button class="btn btn-outline-secondary" @onclick="Cancel">Cancel</button>
</div>


@if (!string.IsNullOrWhiteSpace(ErrorMessage))
{
    <div class="alert alert-danger">@ErrorMessage</div>
}


<EditForm Model="Item" OnValidSubmit="SaveAsync" class="new-form">
    <div class="form-group">
        <label>SKU</label>
        <InputText class="form-control" @bind-Value="Item.Sku" placeholder="e.g. SKU-12345" />
    </div>

    <div class="form-group">
        <label>Name</label>
        <InputText class="form-control" @bind-Value="Item.Name" placeholder="Short description" />
    </div>

    <div class="form-group">
        <label>Unit Price</label>
        <InputNumber class="form-control" @bind-Value="Item.UnitPrice" step="0.01" />
    </div>

    <div class="form-group">
        <label>Low-Stock Threshold</label>
        <InputNumber class="form-control" @bind-Value="Item.LowStockThreshold" />
    </div>

    <button type="submit" class="btn btn-primary" disabled="@IsSubmitting">
        @(IsSubmitting ? "Creating…" : "Create Item")
    </button>
</EditForm>

@code {
    private DtoItem Item = new();
    private string? ErrorMessage;
    private bool IsSubmitting;

    protected override void OnInitialized()
    {

        Item = new DtoItem
        {

            UnitPrice = 0,
            LowStockThreshold = 0
        };
    }

    private async Task SaveAsync()
    {
        ErrorMessage = null;

        if (string.IsNullOrWhiteSpace(Item.Sku) || string.IsNullOrWhiteSpace(Item.Name))
        {
            ErrorMessage = "SKU and Name are required.";
            return;
        }

        IsSubmitting = true;
        try
        {
            var errors = new List<string>();
            var ok = await ItemApi.CreateItemAsync(Item, errors);

            if (!ok)
            {
                ErrorMessage = string.Join("; ", errors);
                return;
            }

            Nav.NavigateTo("/items");
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to create item: " + ex.Message;
        }
        finally
        {
            IsSubmitting = false;
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/items");
    }
}
